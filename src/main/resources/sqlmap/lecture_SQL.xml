<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.mapper.LectureMapper">

	<sql id="where">
		<!-- 강의 검색 -->
		and  (  L.LECA_CD     LIKE '%' || #{keyword} || '%'
	    or      E.EMP_NM      LIKE '%' || #{keyword} || '%'
	  	or      LA.LECA_NM    LIKE '%' || #{keyword} || '%'
	 	or      LA.LECA_CRD   LIKE '%' || #{keyword} || '%'
	 	or      LA.LECA_CAP   LIKE '%' || #{keyword} || '%'
	 	or      LA.LECA_CATE  LIKE '%' || #{keyword} || '%'
	 	or      LA.LECA_YR    LIKE '%' || #{keyword} || '%')
	</sql>
	
	<sql id="where2">
		<!-- 강의 검색 -->
	  	and  (  LA.LECA_NM    LIKE '%' || #{keyword} || '%'
	 	or      LA.LECA_SEM   LIKE '%' || #{keyword} || '%'
	 	or      LA.LECA_YR    LIKE '%' || #{keyword} || '%')
	</sql>
	
	<!-- lecture resultMap======================================================================== -->
	<resultMap type="lecture" id="lectureMap">
		<result property="lecaCd" column="LECA_CD" />
		<result property="subCd" column="SUB_CD" />
		<result property="lecYn" column="LEC_YN" />
		<result property="lecHcnt" column="LEC_HCNT" />
		<result property="lecaYn" column="LECA_YN" />
		<result property="depCd" column="DEP_CD" />
		<collection property="lecApply" resultMap="lecApplyMap"></collection>
		<collection property="employee" resultMap="employeeMap"></collection>
		<collection property="department" resultMap="departmentMap"></collection>
    <collection property="taskList" resultMap="taskMap"></collection>
	</resultMap>
	
	<!-- employee resultMap======================================================================== -->
	<resultMap type="employee" id="employeeMap">
		<result property="empNo"  column="EMP_NO" />
		<result property="empNm" column="EMP_NM" />
		<result property="empNme" column="EMP_NME" />
		<result property="empTel" column="EMP_TEL" />
		<result property="empTel2"  column="EMP_TEL2" />
		<result property="empZip" column="EMP_ZIP" />
		<result property="empAddr1"  column="EMP_ADDR1" />
		<result property="empAddr2"  column="EMP_ADDR2" />
		<result property="empReg" column="EMP_REG" />
		<result property="empBankCd"  column="EMP_BANK_CD" />
		<result property="empDepo"  column="EMP_DEPO" />
		<result property="empAct" column="EMP_ACT" />
		<result property="empPic" column="EMP_PIC" />
		<result property="empJoin"  column="EMP_JOIN" />
		<result property="empRet" column="EMP_RET" />
	</resultMap>
	
	<!-- lecApply resultMap======================================================================== -->
	<resultMap type="lecApply" id="lecApplyMap">
		<result property="lecaCd"  column="LECA_CD" />
		<result property="lecaYr"  column="LECA_YR" />
		<result property="lecaSem" column="LECA_SEM" />
		<result property="lecaNm"  column="LECA_NM" />
		<result property="lecaCon" column="LECA_CON" />
		<result property="lecaTrg" column="LECA_TRG" />
		<result property="lecaCrd" column="LECA_CRD" />
		<result property="lecaPer" column="LECA_PER" />
		<result property="lecaCap" column="LECA_CAP" />
		<result property="lecaTm"  column="LECA_TM" />
		<result property="lecaWk"  column="LECA_WK" />
		<result property="lecaHall" column="LECA_HALL" />
		<result property="lecaUnit" column="LECA_UNIT" />
		<result property="lecaBook" column="LECA_BOOK" />
		<result property="lecaNote" column="LECA_NOTE" />
		<result property="lecaDt" column="LECA_DT" />
		<result property="lecaGrade" column="LECA_GRADE" />
		<result property="lecaImsiYn" column="LECA_IMSI_YN" />
		<result property="lecaCate" column="LECA_CATE" />
		<result property="lecaMp" column="LECA_MP" />
		<result property="lecaFp" column="LECA_FP" />
		<result property="lecaTp" column="LECA_TP" />
		<result property="lecaAp" column="LECA_AP" />
	</resultMap>
	
	<!-- DEPARTMENT resultMap======================================================================== -->
	<resultMap type="department" id="departmentMap">
		<result property="depCd"  column="DEP_CD" />
		<result property="colCd"  column="COL_CD" />
		<result property="proNo"  column="PRO_NO" />
		<result property="depNm"  column="DEP_NM" />
		<result property="depDes" column="DEP_DES" />
		<result property="depCap" column="DEP_CAP" />
		<result property="depTel" column="DEP_TEL" />
		<result property="empNo"  column="EMP_NO"/>
	</resultMap>
  
  <!-- task resultMap======================================================================== -->                                                                                                                                              
	<resultMap type="task" id="taskMap">                                                                                                                                                                                                               
		<result property="taskCd" column="TASK_CD"/>                                                                                                                                                                                                   
		<result property="lecaCd" column="LECA_CD"/>                                                                                                                                                                                                   
		<result property="taskNm" column="TASK_NM"/>                                                                                                                                                                                                   
		<result property="taskCon" column="TASK_CON"/>                                                                                                                                                                                                 
		<result property="taskSdt" column="TASK_SDT"/>                                                                                                                                                                                                 
		<result property="taskEdt" column="TASK_EDT"/>                                                                                                                                                                                                 
		<result property="atchFileId" column="ATCH_FILE_ID" />    
		<collection property="attach" resultMap="attachMap"></collection>                                                                                                                                                                                     
	</resultMap>   
	
<!-- attach resultMap======================================================================== -->
	<resultMap type="attach" id="attachMap">
		<result property="atchFileId"     column="ATCH_FILE_ID"/>                                                                                                                                                                                                   
		<result property="fileSn"          column="FILE_SN"/>                                                                                                                                                                                                   
		<result property="fileStreCours"  column="FILE_STRE_COURS"/>                                                                                                                                                                                                   
		<result property="streFileNm"     column="STRE_FILE_NM"/>                                                                                                                                                                                                 
		<result property="orignlFileNm"   column="ORIGNL_FILE_NM"/>                                                                                                                                                                                                 
		<result property="fileExtsn"       column="FILE_EXTSN"/>                                                                                                                                                                                                 
		<result property="fileSize"        column="FILE_SIZE"/>    
		<result property="createDt"        column="CREATE_DT"/>    
	</resultMap>
	
	<!-- 이번 학기 전체 강의 목록======================================================================== -->
	<select id="lectureSearch" parameterType="string" resultMap="lectureMap">
		SELECT 
		       L.LECA_CD 
		     , E.EMP_NM 
		     , LA.LECA_NM 
		     , LA.LECA_CRD 
		     , D.DEP_NM
		     , LA.LECA_CAP 
		     , LA.LECA_CATE 
		     , LA.LECA_YR
		     , LA.LECA_SEM
		FROM PROFESSOR P, EMPLOYEE E, SUBJECT S, LECTURE L, LEC_APPLY LA, DEPARTMENT D
		WHERE E.EMP_NO = P.PRO_NO AND P.PRO_NO = S.PRO_NO 
		AND S.SUB_CD = L.SUB_CD AND L.LECA_CD = LA.LECA_CD AND L.DEP_CD = D.DEP_CD
		<if test="keyword != null and keyword !=''">
				<include refid="where"></include>
		</if>
	</select>
	
	<!-- 담당 강의 조회 (교수가 담당한 강의 검색)======================================================================== -->
	<select id="professorLecture" resultMap="lectureMap" parameterType="string">
		SELECT L.LECA_CD
		     , LA.LECA_NM 
		     , LA.LECA_YR
		     , LA.LECA_SEM
		FROM PROFESSOR P, EMPLOYEE E, SUBJECT S, LECTURE L, LEC_APPLY LA, DEPARTMENT D
		WHERE E.EMP_NO = P.PRO_NO AND P.PRO_NO = S.PRO_NO 
		AND S.SUB_CD = L.SUB_CD AND L.LECA_CD = LA.LECA_CD AND L.DEP_CD = D.DEP_CD
		AND S.PRO_NO = #{professorId}
<!-- 		<if test="keyword != null and keyword !=''"> -->
<!-- 				<include refid="where2"></include> -->
<!-- 		</if> -->
	</select>
  
  <select id="searchTask" resultMap="lectureMap" parameterType="String">                                                                                                                                                                                                    
	select LA.LECA_NM,
	       LA.LECA_CD,
	       T.TASK_CD,
	       T.TASK_NM,
	       T.TASK_CON,
	       T.TASK_SDT,
	       T.TASK_EDT
	from LECTURE L, TASK T, LEC_APPLY LA
	WHERE L.LECA_CD = T.LECA_CD
	AND LA.LECA_CD = L.LECA_CD
	and LA.LECA_CD = #{lecaCd}                                                                                                                                                                                                                      
	</select>       
	
	<select id="studentNotYetApplyLectureList" parameterType="studentLecture" resultMap="lectureMap">
		WITH T AS (
		            SELECT
		                L.LECA_CD,
		                E.EMP_NM,
		                LA.LECA_NM,
		                LA.LECA_CRD,
		                LA.LECA_TRG,
		                L.LEC_HCNT,
		                D.DEP_NM,
		                LA.LECA_CAP,
		                LA.LECA_CATE,
		                LA.LECA_YR,
		                LA.LECA_SEM,
		                C.COL_NM
		            FROM
		                DEPARTMENT D
		                INNER JOIN COLLEGE C ON(D.COL_CD = C.COL_CD)
		                INNER JOIN PROFESSOR P ON ( P.DEP_CD = D.DEP_CD )
		                INNER JOIN EMPLOYEE E ON ( E.EMP_NO = P.PRO_NO)
		                INNER JOIN SUBJECT S ON ( P.PRO_NO = S.PRO_NO )
		                INNER JOIN LECTURE L ON ( S.SUB_CD = L.SUB_CD )
		                INNER JOIN LEC_APPLY LA ON ( L.LECA_CD = LA.LECA_CD )
		            WHERE
		                L.LEC_YN = 'Y'
		            AND LA.LECA_SEM = 
		                DECODE(TO_CHAR(SYSDATE,'MM'),'12','1학기','01','1학기','02','1학기','03','1학기','04','1학기','05','1학기','2학기')
		)
		SELECT * FROM T
		WHERE NOT EXISTS(
		    SELECT SL.LECA_CD
		    FROM STU_LEC SL
		    WHERE SL.STU_NO = #{stuNo}
		    AND SL.LECA_CD = T.LECA_CD
		)
		<if test="colNm != null and colNm != ''">
			AND COL_NM LIKE '%' || #{colNm} || '%'
		</if>
		<if test="depNm != null and depNm != ''">
			AND DEP_NM LIKE '%' || #{depNm} || '%'
		</if>
		<if test="lecaTrg != null and lecaTrg != ''">
			AND LECA_TRG LIKE '%' || #{lecaTrg} || '%'
		</if>
		<if test="lecaCate != null and lecaCate != ''">
			AND LECA_CATE LIKE '%' || #{lecaCate} || '%'
		</if>
		<if test="lecaNm != null and lecaNm != ''">
			AND LECA_NM LIKE '%' || #{lecaNm} || '%'
		</if>
	</select>
	
	<select id="studentCompleteApplyLectureList" parameterType="studentLecture" resultMap="lectureMap"> 
		SELECT 
		       L.LECA_CD 
		     , E.EMP_NM 
		     , LA.LECA_NM 
		     , LA.LECA_CRD 
		     , LA.LECA_TRG
		     , L.LEC_HCNT
		     , D.DEP_NM
		     , LA.LECA_CAP 
		     , LA.LECA_CATE 
		     , LA.LECA_YR
		     , LA.LECA_SEM
		     , SL.STU_NO
		FROM PROFESSOR P INNER JOIN EMPLOYEE E ON(E.EMP_NO = P.PRO_NO)
		                INNER JOIN SUBJECT S ON(P.PRO_NO = S.PRO_NO)
		                INNER JOIN LECTURE L ON(S.SUB_CD = L.SUB_CD)
		                INNER JOIN LEC_APPLY LA ON(L.LECA_CD = LA.LECA_CD)
		                INNER JOIN DEPARTMENT D ON(L.DEP_CD = D.DEP_CD)
		                LEFT OUTER JOIN STU_LEC SL ON(SL.LECA_CD = L.LECA_CD)
		WHERE SL.STU_NO = #{stuNo}
	</select>

	<insert id="insertTask" parameterType="task">
		<selectKey keyProperty="atchFileId" order="BEFORE" resultType="int"> 
			select max(ATCH_FILE_ID) FROM ATTACH
		</selectKey>
		insert into TASK (TASK_CD, LECA_CD, TASK_NM, TASK_CON, TASK_SDT, TASK_EDT, ATCH_FILE_ID)
            values((select max(task_cd)+1 from task), #{lecaCd},#{taskNm},#{taskCon},SYSDATE,#{taskEdt},#{atchFileId})
	</insert>
	
	<select id="studentNotYetSaveLectureList" parameterType="studentLecture" resultMap="lectureMap">
		WITH T AS (
		            SELECT
		                L.LECA_CD,
		                E.EMP_NM,
		                LA.LECA_NM,
		                LA.LECA_CRD,
		                LA.LECA_TRG,
		                L.LEC_HCNT,
		                D.DEP_NM,
		                LA.LECA_CAP,
		                LA.LECA_CATE,
		                LA.LECA_YR,
		                LA.LECA_SEM,
		                C.COL_NM
		            FROM
		                DEPARTMENT D
		                INNER JOIN COLLEGE C ON(D.COL_CD = C.COL_CD)
		                INNER JOIN PROFESSOR P ON ( P.DEP_CD = D.DEP_CD )
		                INNER JOIN EMPLOYEE E ON ( E.EMP_NO = P.PRO_NO)
		                INNER JOIN SUBJECT S ON ( P.PRO_NO = S.PRO_NO )
		                INNER JOIN LECTURE L ON ( S.SUB_CD = L.SUB_CD )
		                INNER JOIN LEC_APPLY LA ON ( L.LECA_CD = LA.LECA_CD )
		            WHERE
		                L.LEC_YN = 'Y'
		            AND LA.LECA_SEM = 
		                DECODE(TO_CHAR(SYSDATE,'MM'),'12','1학기','01','1학기','02','1학기','03','1학기','04','1학기','05','1학기','2학기')
		)
		SELECT * FROM T
		WHERE NOT EXISTS(
		    SELECT W.LECA_CD
		    FROM WISH W
		    WHERE W.STU_NO = #{stuNo}
		    AND W.LECA_CD = T.LECA_CD
		)
		<if test="depNm != null and depNm != ''">
			AND DEP_NM LIKE '%' || #{depNm} || '%'
		</if>
		<if test="lecaTrg != null and lecaTrg != ''">
			AND LECA_TRG LIKE '%' || #{lecaTrg} || '%'
		</if>
		<if test="lecaCate != null and lecaCate != ''">
			AND LECA_CATE LIKE '%' || #{lecaCate} || '%'
		</if>
		<if test="lecaNm != null and lecaNm != ''">
			AND LECA_NM LIKE '%' || #{lecaNm} || '%'
		</if>
	</select>
	
	<select id="studentCompleteSaveLectureList" parameterType="studentLecture" resultMap="lectureMap">  
		SELECT 
		       L.LECA_CD 
		     , E.EMP_NM 
		     , LA.LECA_NM 
		     , LA.LECA_CRD 
		     , LA.LECA_TRG
		     , L.LEC_HCNT
		     , D.DEP_NM
		     , LA.LECA_CAP 
		     , LA.LECA_CATE 
		     , LA.LECA_YR
		     , LA.LECA_SEM
		     , W.STU_NO
		FROM DEPARTMENT D
		                INNER JOIN PROFESSOR P ON ( P.DEP_CD = D.DEP_CD )
		                INNER JOIN EMPLOYEE E ON ( E.EMP_NO = P.PRO_NO)
		                INNER JOIN SUBJECT S ON ( P.PRO_NO = S.PRO_NO )
		                INNER JOIN LECTURE L ON ( S.SUB_CD = L.SUB_CD )
		                INNER JOIN LEC_APPLY LA ON ( L.LECA_CD = LA.LECA_CD )
		                LEFT OUTER JOIN WISH W ON(W.LECA_CD = L.LECA_CD)
		WHERE W.STU_NO = #{stuNo}
	</select>
	
	<insert id="insertTask2" parameterType="task">
		<selectKey keyProperty="taskCd" order="BEFORE" resultType="int"> 
			select max(TASK_CD)+1 FROM TASK
		</selectKey>
		insert into TASK (TASK_CD, LECA_CD, TASK_NM, TASK_CON, TASK_SDT, TASK_EDT)
            values(#{taskCd},#{lecaCd},#{taskNm},#{taskCon},SYSDATE,#{taskEdt})
	</insert>

	<update id="increaseHeadcount" parameterType="studentLecture">
		UPDATE LECTURE
		    SET LEC_HCNT = (SELECT LEC_HCNT FROM LECTURE WHERE LECA_CD = #{lecaCd}) + 1
		WHERE LECA_CD = #{lecaCd}
	</update>
	
	<select id="detailTask" resultType="task" parameterType="String" resultMap="taskMap">
		SELECT                 
				T.TASK_CD      
		      , T.LECA_CD      
		      , T.TASK_NM      
		      , T.TASK_CON     
		      , T.TASK_SDT     
		      , T.TASK_EDT     
		      , T.ATCH_FILE_ID
		      , A.ATCH_FILE_ID
		      , A.FILE_SN
		      , A.FILE_STRE_COURS
		      , A.STRE_FILE_NM
		      , A.ORIGNL_FILE_NM
		      , A.FILE_EXTSN
		      , A.FILE_SIZE
		      , A.CREATE_DT
		FROM    TASK T LEFT OUTER JOIN ATTACH A ON(T.ATCH_FILE_ID  =  A.ATCH_FILE_ID)
		WHERE   
			    T.TASK_CD = #{taskCd} 
		AND     T.LECA_CD = #{lecaCd}      
	</select>
	
	<select id="loadNotApplySaveLecture" parameterType="studentLecture" resultMap="lectureMap">
		SELECT 
		       L.LECA_CD 
		     , E.EMP_NM 
		     , LA.LECA_NM 
		     , LA.LECA_CRD 
		     , LA.LECA_TRG
		     , L.LEC_HCNT
		     , D.DEP_NM
		     , LA.LECA_CAP 
		     , LA.LECA_CATE 
		     , LA.LECA_YR
		     , LA.LECA_SEM
		     , W.STU_NO
		     , SL.STU_NO
		FROM DEPARTMENT D
		                INNER JOIN PROFESSOR P ON ( P.DEP_CD = D.DEP_CD )
		                INNER JOIN EMPLOYEE E ON ( E.EMP_NO = P.PRO_NO)
		                INNER JOIN SUBJECT S ON ( P.PRO_NO = S.PRO_NO )
		                INNER JOIN LECTURE L ON ( S.SUB_CD = L.SUB_CD )
		                INNER JOIN LEC_APPLY LA ON ( L.LECA_CD = LA.LECA_CD )
		                LEFT OUTER JOIN WISH W ON(W.LECA_CD = L.LECA_CD)
		                LEFT OUTER JOIN STU_LEC SL ON(W.LECA_CD = SL.LECA_CD AND W.STU_NO = SL.STU_NO)
		WHERE W.STU_NO = #{stuNo}
		AND SL.STU_NO IS NULL
	</select>

	
</mapper>